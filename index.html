<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>БЕТОН — Де в Києві найкраще купити житло</title>

<!-- Leaflet CSS (без integrity, бо браузер блокує при невірному значенні) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

<style>
  /* --- БАЗОВІ СТИЛІ  --- */
  :root{
    --accent: #0b6b4f;   /* зелено-смарагдовий */
    --accent-2: #ffcc00; /* жовтий акцент */
    --muted: #6b7280;
    --panel-bg: #fff;
    --glass: rgba(255,255,255,0.9);
  }
  html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:#f3f6f8;color:#111}
  header{background:linear-gradient(0deg,var(--accent) 0%, #0a5d47 100%);color:#fff;padding:14px 18px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
  .brand{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px}
  .brand h1{font-size:20px;margin:0}
  .brand p{margin:0;opacity:0.95;font-size:14px}

  main.container{max-width:1200px;margin:18px auto;padding:12px;display:block}

  /* layout: left sidebar (filters) | center map | right panel (list) */
  .layout{display:grid;grid-template-columns:280px 1fr 360px;gap:14px;align-items:start}
  @media(max-width:1100px){
    .layout{grid-template-columns: 1fr; }
  }

  /* --- LEFT SIDEBAR (фільтри) --- */
  .sidebar{background:var(--panel-bg);border-radius:8px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.05)}
  .sidebar h3{margin:4px 0 10px;color:var(--accent)}
  .filter-group{margin-bottom:12px}
  .filter-group label{display:block;font-weight:600;margin-bottom:6px;font-size:13px}
  .checkbox-list{display:flex;flex-direction:column;gap:6px}
  .checkbox-list label{font-size:14px;color:#222}
  .small{font-size:13px;color:var(--muted)}

  .range-row{display:flex;gap:8px;align-items:center}
  input[type="range"]{width:100%}

  .btn{display:inline-block;padding:9px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .btn.secondary{background:#e7eef0;color:#0b6b4f;border:1px solid #d6e6e2}

  /* --- MAP --- */
  .map-card{border-radius:8px;overflow:hidden;border:1px solid #e6eaee;background:#fff;box-shadow:0 8px 26px rgba(11,107,79,0.06)}
  #map{width:100%;height:640px;display:block} /* важливо - висота карти */

  /* --- RIGHT PANEL (список районів + таблиця) --- */
  .panel{background:var(--panel-bg);border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.05)}
  .panel h3{margin:6px 0;color:var(--accent)}
  .district-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;border:1px solid #f0f0f0;margin-bottom:8px;background:#fff;cursor:pointer}
  .district-row:hover{background:#f8fff9}
  .district-name{font-weight:700}
  .district-meta{font-size:13px;color:var(--muted)}
  .bar{height:8px;border-radius:6px;background:#eee;overflow:hidden;margin-top:6px}
  .bar .fill{height:100%;background:linear-gradient(90deg,var(--accent) 0%, var(--accent-2) 100%);width:50%}

  .stats-table{width:100%;border-collapse:collapse;margin-top:10px}
  .stats-table th, .stats-table td{padding:6px;border-bottom:1px solid #f0f0f0;font-size:13px;text-align:left}
  .stats-table th{background:#fafafa;font-weight:700}

  /* --- FLOATING TOP-3 --- */
  .top3-box{position:fixed;right:18px;bottom:18px;z-index:999;min-width:220px;background:var(--glass);backdrop-filter:blur(6px);border-radius:10px;padding:10px;border:1px solid rgba(0,0,0,0.06);box-shadow:0 10px 30px rgba(0,0,0,0.08)}
  .top3-box h4{margin:0 0 6px;font-size:15px;color:#0b6b4f}
  .top3-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;cursor:pointer}
  .top3-item:hover{background:#fff}

  /* misc */
  footer{max-width:1200px;margin:18px auto;padding:12px;color:#666;font-size:13px;text-align:center}
</style>
</head>
<body>
<header>
  <div class="brand">
    <h1>БЕТОН</h1>
    <p>Інтерактивна мапа: де в Києві найкраще купити житло — критерії, рейтинги, статистика</p>
  </div>
</header>

<main class="container">
  <div class="layout">

    <!-- LEFT: FILTERS -->
    <aside class="sidebar" id="filters">
      <h3>Фільтри та критерії</h3>

      <div class="filter-group">
        <label for="filter_type">Тип житла</label>
        <select id="filter_type" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eaee">
          <option value="">Будь-який</option>
          <option value="apartment">Квартира</option>
          <option value="studio">Студія</option>
          <option value="house">Будинок</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filter_price">Ціна (макс), грн/м²</label>
        <div class="range-row">
          <input id="filter_price" type="number" placeholder="Наприклад 40000" style="padding:8px;border-radius:8px;border:1px solid #e6eaee;width:120px" />
          <button class="btn secondary" id="price_reset" type="button">Скинути</button>
        </div>
        <div class="small" style="margin-top:6px">Вкажи ліміт ціни на квадратний метр</div>
      </div>

      <div class="filter-group">
        <label>Інфраструктура (відмітьте потрібне)</label>
        <div class="checkbox-list">
          <label for="crit_schools"><input id="crit_schools" type="checkbox" class="crit" data-crit="schools" /> Багато шкіл</label>
          <label for="crit_kindergartens"><input id="crit_kindergartens" type="checkbox" class="crit" data-crit="kindergartens" /> Багато дитсадків</label>
          <label for="crit_universities"><input id="crit_universities" type="checkbox" class="crit" data-crit="universities" /> Поруч університети</label>
          <label for="crit_metro"><input id="crit_metro" type="checkbox" class="crit" data-crit="metro" /> Біля метро</label>
          <label for="crit_parks"><input id="crit_parks" type="checkbox" class="crit" data-crit="parks" /> Парки/зелені зони</label>
          <label for="crit_jobs"><input id="crit_jobs" type="checkbox" class="crit" data-crit="jobs" /> Багато робочих місць</label>
        </div>
      </div>

      <div class="filter-group">
        <label>Вага критеріїв (регулюйте, щоб змінити результати)</label>
        <div class="small">Транспорт</div>
        <input id="w_transport" type="range" min="0" max="100" value="30" />
        <div class="small">Інфраструктура</div>
        <input id="w_infra" type="range" min="0" max="100" value="30" />
        <div class="small">Безпека</div>
        <input id="w_safety" type="range" min="0" max="100" value="20" />
        <div class="small">Шум (мінімізувати)</div>
        <input id="w_noise" type="range" min="0" max="100" value="20" />
      </div>

      <div style="display:flex;gap:8px;justify-content:space-between;margin-top:8px">
        <button class="btn" id="applyFilters" type="button">Показати результати</button>
        <button class="btn secondary" id="resetFilters" type="button">Скинути</button>
      </div>

      <hr style="margin:12px 0" />

      <div class="small">Порада: комбінуй фільтри і відрегулюй ваги, щоб підібрати райони під свій стиль життя.</div>
    </aside>

    <!-- CENTER: MAP -->
    <section>
      <div class="map-card">
        <div id="map" aria-label="Карта районів Києва"></div>
      </div>

      <!-- Таблиця статистики під картою (широка) -->
      <div style="margin-top:12px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.04)">
        <h3 style="margin:0 0 8px;color:var(--accent)">Таблиця статистики по районам (коротко)</h3>
        <div style="overflow:auto">
          <table class="stats-table" id="statsTable" style="width:100%">
            <thead>
              <tr><th>Район</th><th>Населення</th><th>Шкіл</th><th>Садків</th><th>Метро</th><th>Робочих місць (прибл.)</th><th>Середня ціна, грн/м²</th></tr>
            </thead>
            <tbody>
              <!-- rows will be injected -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RIGHT: LIST OF DISTRICTS -->
    <aside class="panel" id="rightPanel">
      <h3>Райони (в порядку релевантності)</h3>
      <div id="districtList">
        <!-- district rows injected here -->
      </div>

      <hr style="margin:12px 0" />
      <div>
        <h4 style="margin:0 0 6px">Пояснення рейтингу</h4>
        <div class="small">Рейтинг розраховується за вагою критеріїв зліва. Шум враховується негативно.</div>
      </div>
    </aside>

  </div>
</main>

<!-- FLOATING TOP-3 -->
<div class="top3-box" id="top3Box" aria-live="polite">
  <h4>ТОП-3 районів</h4>
  <div id="top3List">
    <!-- injected -->
    <div class="top3-item">1. —</div>
    <div class="top3-item">2. —</div>
    <div class="top3-item">3. —</div>
  </div>
</div>

<footer>© <span id="year"></span> БЕТОН — демо.</footer>

<!-- Leaflet JS (без integrity) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* =============== DATA =============== */
  const districts = [
    { id:'pechersk', name:'Печерський', population:150000, schools:22, kindergartens:18, metro:4, jobs:120000, price_avg:52000,
      coords: [[30.520,50.430],[30.545,50.430],[30.545,50.447],[30.520,50.447]] },
    { id:'podil', name:'Подільський', population:140000, schools:18, kindergartens:10, metro:5, jobs:90000, price_avg:42000,
      coords: [[30.505,50.445],[30.525,50.445],[30.525,50.463],[30.505,50.463]] },
    { id:'obolon', name:'Оболонський', population:180000, schools:30, kindergartens:25, metro:3, jobs:70000, price_avg:35000,
      coords: [[30.505,50.485],[30.535,50.485],[30.535,50.503],[30.505,50.503]] },
    { id:'holosiiv', name:'Голосіївський', population:200000, schools:40, kindergartens:30, metro:3, jobs:80000, price_avg:40000,
      coords: [[30.48,50.405],[30.53,50.405],[30.53,50.435],[30.48,50.435]] },
    { id:'solom', name:'Солом\'янський', population:170000, schools:35, kindergartens:22, metro:4, jobs:95000, price_avg:39000,
      coords: [[30.47,50.43],[30.495,50.43],[30.495,50.455],[30.47,50.455]] },
    { id:'darnytsky', name:'Дарницький', population:310000, schools:60, kindergartens:45, metro:6, jobs:110000, price_avg:33000,
      coords: [[30.56,50.43],[30.595,50.43],[30.595,50.47],[30.56,50.47]] },
    { id:'desna', name:'Деснянський', population:350000, schools:55, kindergartens:40, metro:2, jobs:65000, price_avg:30000,
      coords: [[30.57,50.49],[30.61,50.49],[30.61,50.525],[30.57,50.525]] },
    { id:'sviatoshyn', name:'Святошинський', population:200000, schools:42, kindergartens:32, metro:3, jobs:70000, price_avg:31000,
      coords: [[30.35,50.435],[30.415,50.435],[30.415,50.475],[30.35,50.475]] }
  ];

  const points = [
    {type:'school', name:'Ліцей №1 (Печерськ)', coords:[50.437,30.532], district:'pechersk'},
    {type:'kindergarten', name:'Садок №12 (Печерськ)', coords:[50.439,30.534], district:'pechersk'},
    {type:'metro', name:'Кловська (метро)', coords:[50.435,30.530], district:'pechersk'},
    {type:'university', name:'Університет Печерськ', coords:[50.438,30.538], district:'pechersk'},
    {type:'school', name:'Школа №22 (Поділ)', coords:[50.456,30.515], district:'podil'},
    {type:'metro', name:'Контрактова площа', coords:[50.450,30.515], district:'podil'},
    {type:'park', name:'Парк Оболонь', coords:[50.497,30.522], district:'obolon'},
    {type:'school', name:'Школа №5 (Оболонь)', coords:[50.492,30.520], district:'obolon'},
    {type:'park', name:'Голосіївський парк', coords:[50.415,30.514], district:'holosiiv'},
    {type:'school', name:'Школа №78 (Голосіїв)', coords:[50.418,30.510], district:'holosiiv'},
    {type:'metro', name:'Вокзальна', coords:[50.437,30.520], district:'solom'},
    {type:'job', name:'Офісний центр', coords:[50.435,30.518], district:'solom'},
    {type:'school', name:'Школа Дарниця', coords:[50.431,30.572], district:'darnytsky'},
    {type:'metro', name:'Лівобережна', coords:[50.451,30.557], district:'darnytsky'},
    {type:'school', name:'Школа Деснянська', coords:[50.510,30.577], district:'desna'},
    {type:'park', name:'Парк Святошин', coords:[50.450,30.380], district:'sviatoshyn'}
  ];

  /* ================ MAP INIT ================ */
  const map = L.map('map',{preferCanvas:true}).setView([50.45,30.52], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution: '&copy; OpenStreetMap contributors',
    maxZoom:19
  }).addTo(map);
  setTimeout(()=>{ try{ map.invalidateSize(); }catch(e){} }, 300);

  /* icons */
  function svgIcon(color, label){
    const svg = encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><circle cx="12" cy="10" r="7" fill="${color}"/><text x="12" y="14" font-size="10" fill="#fff" text-anchor="middle">${label}</text></svg>`
    );
    return L.icon({iconUrl: 'data:image/svg+xml;utf8,'+svg, iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-26]});
  }
  const icons = {
    school: svgIcon('#1f8ef1','S'),
    kindergarten: svgIcon('#f39c12','K'),
    university: svgIcon('#9b59b6','U'),
    metro: svgIcon('#e74c3c','M'),
    park: svgIcon('#2ecc71','P'),
    job: svgIcon('#34495e','J')
  };

  /* layers */
  const pointLayerGroup = L.layerGroup().addTo(map);
  const districtLayerGroup = L.layerGroup().addTo(map);
  const districtLayers = {};

  districts.forEach(d=>{
    const latlngs = d.coords.map(c => [c[1], c[0]]);
    const poly = L.polygon(latlngs, { color:'#c0d6cf', weight:1, fillColor:'#f7f9f8', fillOpacity:0.5 }).addTo(districtLayerGroup);
    poly.bindTooltip(`<strong>${d.name}</strong><br/>Ціна: ${d.price_avg.toLocaleString()} грн/м²`, {sticky:true});
    poly.on('click', ()=> showDistrictDetail(d.id));
    districtLayers[d.id] = poly;
  });

  points.forEach(p=>{
    const marker = L.marker(p.coords, {icon: icons[p.type] || svgIcon('#777', p.type[0].toUpperCase())});
    marker.bindPopup(`<b>${p.name}</b><br/><small>${p.type}</small>`);
    marker.addTo(pointLayerGroup);
  });

  try{ const group = L.featureGroup(Object.values(districtLayers)); map.fitBounds(group.getBounds().pad(0.12)); }catch(e){}

  /* ================ UI & LOGIC ================ */
  function renderStatsTable(){
    const tbody = document.querySelector('#statsTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    districts.forEach(d=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><a href="districts/${d.id}.html">${d.name}</a></td>
        <td>${(d.population||0).toLocaleString()}</td>
        <td>${d.schools||0}</td>
        <td>${d.kindergartens||0}</td>
        <td>${d.metro||0}</td>
        <td>${(d.jobs||0).toLocaleString()}</td>
        <td>${(d.price_avg||0).toLocaleString()}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderDistrictList(sorted){
    const container = document.getElementById('districtList'); if(!container) return;
    container.innerHTML = '';
    sorted.forEach(d=>{
      const el = document.createElement('div'); el.className='district-row';
      const comfort = d.comfort || 1;
      el.innerHTML = `<div>
          <div class="district-name">${d.name}</div>
          <div class="district-meta small">Комфорт: <strong>${comfort}/10</strong> · ${d.schools} шкіл · ${d.kindergartens} садків</div>
          <div class="bar"><div class="fill" style="width:${comfort*10}%"></div></div>
        </div>
        <div style="text-align:right">
          <div class="small">${(d.price_avg||0).toLocaleString()} грн/м²</div>
          <div style="margin-top:6px"><button class="btn secondary" onclick="openDistrictPage('${d.id}')">Детальніше</button></div>
        </div>`;
      el.addEventListener('click', ()=>{ focusDistrict(d.id); showDistrictDetail(d.id); });
      container.appendChild(el);
    });
  }

  function computeComfortForAll(weights, activeCriteria, priceLimit){
    const totalW = (weights.transport + weights.infra + weights.safety + weights.noise) || 1;
    districts.forEach(d=>{
      const transportScore = Math.min(10, Math.round((d.metro/6)*10));
      const infraScore = Math.min(10, Math.round(((d.schools + d.kindergartens)/ (d.population/10000))*2));
      const safetyScore = 6 + Math.round(((d.jobs/100000)-0.5)*4);
      const noiseScore = 5;
      let criteriaBonus = 0;
      if (activeCriteria.has('schools') && (d.schools||0) > 30) criteriaBonus += 0.5;
      if (activeCriteria.has('kindergartens') && (d.kindergartens||0) > 20) criteriaBonus += 0.5;
      if (activeCriteria.has('universities') && d.universities) criteriaBonus += 0.7;
      if (activeCriteria.has('metro') && (d.metro||0) >= 3) criteriaBonus += 0.8;
      if (activeCriteria.has('parks') && d.parks) criteriaBonus += 0.4;
      if (activeCriteria.has('jobs') && (d.jobs||0) > 80000) criteriaBonus += 0.6;
      const raw = (transportScore*weights.transport + infraScore*weights.infra + safetyScore*weights.safety + (10-noiseScore)*weights.noise) / totalW;
      let comfort = Math.round(raw + criteriaBonus);
      if (priceLimit && d.price_avg > priceLimit) comfort = Math.max(1, comfort - 2);
      comfort = Math.max(1, Math.min(10, comfort));
      d.comfort = comfort;
      d._sub = {transportScore, infraScore, safetyScore, noiseScore, criteriaBonus};
    });
  }

  function getActiveCriteriaSet(){
    const set = new Set();
    document.querySelectorAll('.crit').forEach(cb=>{ if (cb.checked) set.add(cb.dataset.crit); });
    return set;
  }
  function getWeightsFromUI(){
    return {
      transport: parseInt(document.getElementById('w_transport')?.value,10) || 0,
      infra: parseInt(document.getElementById('w_infra')?.value,10) || 0,
      safety: parseInt(document.getElementById('w_safety')?.value,10) || 0,
      noise: parseInt(document.getElementById('w_noise')?.value,10) || 0
    };
  }

  function applyFiltersAndRender(){
    const priceVal = parseInt(document.getElementById('filter_price')?.value,10) || 0;
    const active = getActiveCriteriaSet();
    const weights = getWeightsFromUI();
    computeComfortForAll(weights, active, priceVal);
    const sorted = districts.slice().sort((a,b)=>b.comfort - a.comfort);
    renderDistrictList(sorted);
    renderTop3(sorted.slice(0,3));
    renderStatsTable();
    highlightDistrictsByComfort();
  }

  function highlightDistrictsByComfort(){
    districts.forEach(d=>{
      const layer = districtLayers[d.id];
      if (!layer) return;
      const c = d.comfort || 1;
      const color = c >=9 ? '#005a32' : c>=7 ? '#2ca02c' : c>=5 ? '#ffce73' : c>=3 ? '#ff8c42' : '#c73a00';
      layer.setStyle({fillColor: color, fillOpacity:0.6, color: shadeColor(color,-10)});
    });
  }

  function shadeColor(color, percent) {
    const f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent;
    const R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;
    const newR=Math.round((t-R)*p/100)+R;
    const newG=Math.round((t-G)*p/100)+G;
    const newB=Math.round((t-B)*p/100)+B;
    return "#" + (0x1000000 + (newR<<16) + (newG<<8) + newB).toString(16).slice(1);
  }

  function focusDistrict(id){
    const layer = districtLayers[id];
    if (!layer) return;
    map.fitBounds(layer.getBounds(), {maxZoom:13});
  }

  function showDistrictDetail(id){
    const d = districts.find(x=>x.id===id);
    if (!d) return;
    const layer = districtLayers[id];
    if (layer) {
      const center = layer.getBounds().getCenter();
      L.popup({maxWidth:300})
        .setLatLng(center)
        .setContent(`<strong>${d.name}</strong><br/>Комфорт: ${d.comfort}/10<br/><a href="districts/${d.id}.html">Детальніше про район →</a>`)
        .openOn(map);
    }
  }

  function renderTop3(sortedTop){
    const container = document.getElementById('top3List');
    if (!container) return;
    container.innerHTML = '';
    sortedTop.forEach((d,i)=>{
      const el = document.createElement('div'); el.className='top3-item';
      el.innerHTML = `<div><strong>${i+1}. ${d.name}</strong><div class="small">Комфорт ${d.comfort}/10 · ${d.price_avg.toLocaleString()} грн/м²</div></div>
                      <div><button class="btn secondary" data-id="${d.id}">Відкрити</button></div>`;
      el.addEventListener('click', (e)=>{ openDistrictPage(d.id); });
      container.appendChild(el);
    });
  }

  function openDistrictPage(id){
    if (!id) return;
    window.open(`districts/${id}.html`, '_blank');
  }

  /* initial render */
  applyFiltersAndRender();

  /* events */
  const applyBtn = document.getElementById('applyFilters'); if (applyBtn) applyBtn.addEventListener('click', applyFiltersAndRender);
  const resetBtn = document.getElementById('resetFilters'); if (resetBtn) resetBtn.addEventListener('click', ()=>{
    document.querySelectorAll('.crit').forEach(cb=>cb.checked=false);
    const priceEl = document.getElementById('filter_price'); if (priceEl) priceEl.value='';
    document.getElementById('w_transport').value = 30;
    document.getElementById('w_infra').value = 30;
    document.getElementById('w_safety').value = 20;
    document.getElementById('w_noise').value = 20;
    applyFiltersAndRender();
  });
  const priceReset = document.getElementById('price_reset'); if (priceReset) priceReset.addEventListener('click', ()=>{ const p=document.getElementById('filter_price'); if(p)p.value=''; });

  const statsTable = document.getElementById('statsTable'); if (statsTable) statsTable.addEventListener('click', (e)=>{
    const a = e.target.closest('a');
    if (a){
      const href = a.getAttribute('href');
      if (href && href.startsWith('districts/')){
        const id = href.split('/').pop().replace('.html','');
        focusDistrict(id);
      }
    }
  });

  /* expose for debugging */
  window._BETON = {map, districtLayers, districts, points, applyFiltersAndRender, openDistrictPage};

  document.getElementById('year').textContent = new Date().getFullYear();
}); // DOMContentLoaded
</script>
</body>
</html>
